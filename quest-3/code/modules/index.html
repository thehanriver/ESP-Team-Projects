<!DOCTYPE html>
<html>
  <head>
	  <title>Dynamic Sensor Data</title>
  </head>
  <body>
  	<div id="div1"></div>
  	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  	
  	<script>window.onload = function () {


	var updateInterval = 1000;
	var dataLength = 25; // number of dataPoints visible at any point
	var lastTime = -1;
	var x_dps = [];
	var y_dps = [];
	var z_dps = [];
	var therm_dps = [];

	var chart1 = new CanvasJS.Chart("chartContainer1", {
			title :{
				text: "Dynamic Sensor Data"
			},
			axisX:  {
				title: "Time Since Flash (s)"
			},
			axisY: {
				title: "Temperature (°C)"
			},
			toolTip: {
				shared: true
			},
			legend: {
				cursor: "pointer",
				verticalAlign: "top",
				horizontalAlign: "center",
			},
			data: [{
				type:"line",
				name: "Thermistor",
				showInLegend: true,
				markerSize: 0,
				yValueFormatString: "#,###.00°C",
				dataPoints: therm_dps
			}, {

			}]
		});

		var chart2 = new CanvasJS.Chart("chartContainer2", {
			title :{
				text: "Dynamic Sensor Data"
			},
			axisX:  {
				title: "Time Since Flash (s)"
			},
			axisY: {
				title: "Acceleration (m/s^2)"
			},
			toolTip: {
				shared: true
			},
			legend: {
				cursor: "pointer",
				verticalAlign: "top",
				horizontalAlign: "center",
			},
			data: [{
				type:"line",
				name: "X Acceleration",
				showInLegend: true,
				markerSize: 0,
				yValueFormatString: "#,###.00",
				dataPoints: x_dps
			}, {
				type:"line",
				name: "Y Acceleration",
				showInLegend: true,
				markerSize: 0,
				yValueFormatString: "#,###.00",
				dataPoints: y_dps
			}, {
				type:"line",
				name: "Z Acceleration",
				showInLegend: true,
				markerSize: 0,
				yValueFormatString: "#,###.00",
				dataPoints: z_dps
			}]
		});


	$.ajax({url: "/data", success: function(result){

		jQuery.each(result, function(i, val) {

			message = val.split(',');
			x_dps.push({ x: parseInt(message[0]), y: parseFloat(message[2]) });
			y_dps.push({ x: parseInt(message[0]), y: parseFloat(message[3]) });
			z_dps.push({ x: parseInt(message[0]), y: parseFloat(message[4]) });
			therm_dps.push({ x: parseInt(message[0]), y: parseFloat(message[1]) });

			// if (x_dps.length > dataLength) {
			// 	x_dps.shift();
			// 	y_dps.shift();
			// 	z_dps.shift();
			// 	therm_dps.shift();
			// }

		});


		// var chart1 = new CanvasJS.Chart("chartContainer1", {
		// 	title :{
		// 		text: "Dynamic Sensor Data"
		// 	},
		// 	axisX:  {
		// 		title: "Time Since Flash (s)"
		// 	},
		// 	axisY: {
		// 		title: "Temperature (°C)"
		// 	},
		// 	toolTip: {
		// 		shared: true
		// 	},
		// 	legend: {
		// 		cursor: "pointer",
		// 		verticalAlign: "top",
		// 		horizontalAlign: "center",
		// 	},
		// 	data: [{
		// 		type:"line",
		// 		name: "Thermistor",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00°C",
		// 		dataPoints: therm_dps
		// 	}, {

		// 	}]
		// });

		// var chart2 = new CanvasJS.Chart("chartContainer2", {
		// 	title :{
		// 		text: "Dynamic Sensor Data"
		// 	},
		// 	axisX:  {
		// 		title: "Time Since Flash (s)"
		// 	},
		// 	axisY: {
		// 		title: "Acceleration (m/s^2)"
		// 	},
		// 	toolTip: {
		// 		shared: true
		// 	},
		// 	legend: {
		// 		cursor: "pointer",
		// 		verticalAlign: "top",
		// 		horizontalAlign: "center",
		// 	},
		// 	data: [{
		// 		type:"line",
		// 		name: "X Acceleration",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00",
		// 		dataPoints: x_dps
		// 	}, {
		// 		type:"line",
		// 		name: "Y Acceleration",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00",
		// 		dataPoints: y_dps
		// 	}, {
		// 		type:"line",
		// 		name: "Z Acceleration",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00",
		// 		dataPoints: z_dps
		// 	}]
		// });

		chart1.data[0].dataPoints = therm_dps;
		chart2.data[0].dataPoints = x_dps;
		chart2.data[1].dataPoints = y_dps;
		chart2.data[2].dataPoints = z_dps;

		chart1.render();
		chart2.render();
	}});




	var updateChart = function () {


		$.ajax({url: "/data/last", success: function(result){
			time = parseInt(result[0]);
			console.log("time is " + time.toString());
			if (time>lastTime)
			{
				lastTime = time;
			}
			else if (time==lastTime)
			{
				return;
			}
			else
			{
				x_dps = [];
				y_dps = [];
				z_dps = [];
				therm_dps = [];
				lastTime = time;
			}

			x_dps.push({ x: parseInt(result[0]), y: parseFloat(result[2]) });
			y_dps.push({ x: parseInt(result[0]), y: parseFloat(result[3]) });
			z_dps.push({ x: parseInt(result[0]), y: parseFloat(result[4]) });
			therm_dps.push({ x: parseInt(result[0]), y: parseFloat(result[1]) });
			console.log("therm dps length is " + therm_dps.length.toString());

			if (x_dps.length > dataLength) {
				x_dps.shift();
				y_dps.shift();
				z_dps.shift();
				therm_dps.shift();
			}

		}});
		console.log('rendering')
		console.log(therm_dps);


		// var chart1 = new CanvasJS.Chart("chartContainer1", {
		// 	title :{
		// 		text: "Dynamic Sensor Data"
		// 	},
		// 	axisX:  {
		// 		title: "Time Since Flash (s)"
		// 	},
		// 	axisY: {
		// 		title: "Temperature (°C)"
		// 	},
		// 	toolTip: {
		// 		shared: true
		// 	},
		// 	legend: {
		// 		cursor: "pointer",
		// 		verticalAlign: "top",
		// 		horizontalAlign: "center",
		// 	},
		// 	data: [{
		// 		type:"line",
		// 		name: "Thermistor",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00°C",
		// 		dataPoints: therm_dps
		// 	}, {

		// 	}]
		// });

		// var chart2 = new CanvasJS.Chart("chartContainer2", {
		// 	title :{
		// 		text: "Dynamic Sensor Data"
		// 	},
		// 	axisX:  {
		// 		title: "Time Since Flash (s)"
		// 	},
		// 	axisY: {
		// 		title: "Acceleration (m/s^2)"
		// 	},
		// 	toolTip: {
		// 		shared: true
		// 	},
		// 	legend: {
		// 		cursor: "pointer",
		// 		verticalAlign: "top",
		// 		horizontalAlign: "center",
		// 	},
		// 	data: [{
		// 		type:"line",
		// 		name: "X Acceleration",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00",
		// 		dataPoints: x_dps
		// 	}, {
		// 		type:"line",
		// 		name: "Y Acceleration",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00",
		// 		dataPoints: y_dps
		// 	}, {
		// 		type:"line",
		// 		name: "Z Acceleration",
		// 		showInLegend: true,
		// 		markerSize: 0,
		// 		yValueFormatString: "#,###.00",
		// 		dataPoints: z_dps
		// 	}]
		// });


		chart1.render();
		chart2.render();

	};

	updateChart();
	setInterval(function(){updateChart()}, updateInterval);

}</script>

  	<div id="chartContainer1" style="height: 300px; width: 100%;"></div>
  	<div id="chartContainer2" style="height: 300px; width: 100%;"></div>
  	<button id="On"
			  type="button"
			  onClick="sendOn()"
			  style=" height:50px; width:200px ">
  		Turn On LED
	</button>
	<button id="Off"
			  type="button"
			  onClick="sendOff()"
			  style=" height:50px; width:200px ">
  		Turn Off LED
  	</button>  
  	<button type="button"
			  id="webCam"
			  onclick=" window.location.href='http://vivpi.ddns.net:3434/';"
			  style=" height:50px; width:200px " >
		Webcam
	</button>
	
  	<script type="text/javascript">
		function sendOn() {
			//var name = document.getElementById("OnOff").innerText;
			//if(name === 'Turn On'){
				//document.getElementById("OnOff").innerText = 'Turn Off';
				// POST request to on
		$.post('/status',{led_status: 1},function(data,status){
					console.log('turned on');
				});
			//}
			//else if(name === 'Turn Off'){
			//	document.getElementById("OnOff").innerText = 'Turn On';
				
			//		console.log('turned off');
			//	});
		}

		function sendOff() {
			$.post('/status',{led_status: 0},function(data,status){
				console.log('turned off');
				});
		}
	  </script>
  	<script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
  </body>
</html>